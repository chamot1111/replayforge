"use strict";(self.webpackChunkreplayforge=self.webpackChunkreplayforge||[]).push([[1521],{6580:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>i,contentTitle:()=>a,default:()=>l,frontMatter:()=>r,metadata:()=>c,toc:()=>d});var t=s(4848),o=s(8453);const r={sidebar_position:3},a="Nginx Access File Parse",c={id:"use-case/nginx-access-file-parse",title:"Nginx Access File Parse",description:"proxy.json",source:"@site/docs/use-case/nginx-access-file-parse.md",sourceDirName:"use-case",slug:"/use-case/nginx-access-file-parse",permalink:"/replayforge/docs/use-case/nginx-access-file-parse",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/use-case/nginx-access-file-parse.md",tags:[],version:"current",sidebarPosition:3,frontMatter:{sidebar_position:3},sidebar:"tutorialSidebar",previous:{title:"Uptime Kuma Monitor Postgres Values",permalink:"/replayforge/docs/use-case/uptime-kuma-monitor-postgres-values"},next:{title:"Send Logs to Datadog",permalink:"/replayforge/docs/use-case/logs-to-datadog"}},i={},d=[];function u(e){const n={code:"code",h1:"h1",header:"header",p:"p",pre:"pre",...(0,o.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"nginx-access-file-parse",children:"Nginx Access File Parse"})}),"\n",(0,t.jsx)(n.p,{children:"proxy.json"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n  "sources": [\n    {\n      "id": "nginx_access_log",\n      "type": "logfile",\n      "params": {\n        "filePath": "./nginx/access.log",\n        "removeAfterSecs": 3600,\n        "fingerprintLines": 1,\n        "httpPath": "/nginx_access_log"\n      },\n      "transformScript": "./nginx.lua"\n    }\n  ],\n  "sinks": [\n    {\n      "id": "nginx_log_sink",\n      "type": "http",\n      "url": "http://relay-forwarder:8100/",\n      "authBearer": "$RELAY_SECRET",\n      "buckets": ["nginx_log_${ENV_TYPE}"]\n    }\n  ]\n}\n\n'})}),"\n",(0,t.jsx)(n.p,{children:"nginx.lua"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-lua",children:'env_name = os.getenv("ENV_NAME")\ncount = 0\n\nfunction Process(content, emit)\n    contentMap = json_decode(content)\n    bodyStr = contentMap["body"]\n\n    body = json_decode(bodyStr)\n    content = body["content"]\n\n    gr = "%{IPORHOST:client_ip} %{USER:ident} %{USER:auth} \\\\[%{HTTPDATE:timestamp}\\\\] \\"%{WORD:http_method} %{NOTSPACE:request_path} HTTP/%{NUMBER:http_version}\\" %{NUMBER:response_code:int} %{NUMBER:bytes:int} \\"%{DATA:referer}\\" \\"%{DATA:user_agent}\\""\n    values = grok_parse(gr, content)\n\n    count = count + 1\n\n    if values and (count % 100 == 0 or (values.response_code and tonumber(values.response_code) > 399)) then\n        if count % 100 == 0 then\n            count = 0\n        end\n        values.env_name = env_name\n        contentMap["body"] = json_encode(values)\n        emit("nginx_log_sink", json_encode(contentMap))\n    end\nend\n'})})]})}function l(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(u,{...e})}):u(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>a,x:()=>c});var t=s(6540);const o={},r=t.createContext(o);function a(e){const n=t.useContext(r);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:a(e.components),t.createElement(r.Provider,{value:n},e.children)}}}]);